<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>kimmdy.changemanager &mdash; kimmdy 2023 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> kimmdy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">kimmdy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">kimmdy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>kimmdy.changemanager</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for kimmdy.changemanager</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">kimmdy.reaction</span> <span class="kn">import</span> <span class="n">ConversionRecipe</span><span class="p">,</span> <span class="n">ConversionType</span>
<span class="kn">from</span> <span class="nn">kimmdy.constants</span> <span class="kn">import</span> <span class="n">ATOMTYPE_BONDORDER</span>
<span class="kn">from</span> <span class="nn">kimmdy.parsing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">read_plumed</span><span class="p">,</span>
    <span class="n">write_plumed</span><span class="p">,</span>
    <span class="n">read_topol</span><span class="p">,</span>
    <span class="n">write_topol</span><span class="p">,</span>
    <span class="n">split_dihedrals</span><span class="p">,</span>
    <span class="n">merge_propers_impropers</span><span class="p">,</span>
    <span class="n">Topology</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">kimmdy.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">str_to_int_or_0</span><span class="p">,</span>
    <span class="n">check_idx</span><span class="p">,</span>
    <span class="n">sort_bond</span><span class="p">,</span>
    <span class="n">sort_angle</span><span class="p">,</span>
    <span class="n">sort_dihedral</span><span class="p">,</span>
    <span class="n">sort_improper</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">import</span> <span class="nn">re</span>


<div class="viewcode-block" id="modify_top"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.modify_top">[docs]</a><span class="k">def</span> <span class="nf">modify_top</span><span class="p">(</span><span class="n">recipe</span><span class="p">:</span> <span class="n">ConversionRecipe</span><span class="p">,</span> <span class="n">oldtop</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">newtop</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">ffdir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading: </span><span class="si">{</span><span class="n">oldtop</span><span class="si">}</span><span class="s2"> and writing modified topology to </span><span class="si">{</span><span class="n">newtop</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">topology</span> <span class="o">=</span> <span class="n">read_topol</span><span class="p">(</span><span class="n">oldtop</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">conversion</span> <span class="ow">in</span> <span class="n">recipe</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">conversion</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ConversionType</span><span class="o">.</span><span class="n">BREAK</span><span class="p">:</span>
            <span class="n">remove_bond</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">conversion</span><span class="o">.</span><span class="n">atom_idx</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">conversion</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ConversionType</span><span class="o">.</span><span class="n">BIND</span><span class="p">:</span>
            <span class="n">add_bond</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">conversion</span><span class="o">.</span><span class="n">atom_idx</span><span class="p">,</span> <span class="n">ffdir</span><span class="p">)</span>

    <span class="n">write_topol</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">newtop</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_bond"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.remove_bond">[docs]</a><span class="k">def</span> <span class="nf">remove_bond</span><span class="p">(</span><span class="n">topology</span><span class="p">:</span> <span class="n">Topology</span><span class="p">,</span> <span class="n">atompair</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Break bonds in topology.</span>

<span class="sd">    removes bond, angles and dihedrals where breakpair was involved.</span>
<span class="sd">    Modifies the topology dictionary in place.</span>
<span class="sd">    Furthermore, it modifies to function types in the topology to account for radicals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atompair_str</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atompair</span><span class="p">]</span>
    <span class="n">topology</span><span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">bond</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">topology</span><span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atompair_str</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">topology</span><span class="p">[</span><span class="s2">&quot;angles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">angle</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">topology</span><span class="p">[</span><span class="s2">&quot;angles&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">angle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">angle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atompair_str</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">topology</span><span class="p">[</span><span class="s2">&quot;dihedrals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">dihedral</span>
        <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">topology</span><span class="p">[</span><span class="s2">&quot;dihedrals&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dihedral</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dihedral</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dihedral</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dihedral</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atompair_str</span>
        <span class="p">)</span>
    <span class="p">]</span>

    <span class="n">dihpairs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">topology</span><span class="p">[</span><span class="s2">&quot;dihedrals&quot;</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">dihpairs</span><span class="p">:</span>
        <span class="c1"># keep pairs in proper order (which one goes first in the definition)</span>
        <span class="k">if</span> <span class="n">str_to_int_or_0</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">str_to_int_or_0</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pair_int</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">if</span> <span class="n">pair_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pair_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">pair</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">dihpairs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dihpairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_bond</span><span class="p">)</span>

    <span class="n">topology</span><span class="p">[</span><span class="s2">&quot;pairs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">topology</span><span class="p">[</span><span class="s2">&quot;pairs&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pair</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dihpairs</span><span class="p">]</span></div>
    <span class="c1"># TODO; handle parameter update for radicals</span>


<div class="viewcode-block" id="add_bond"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.add_bond">[docs]</a><span class="k">def</span> <span class="nf">add_bond</span><span class="p">(</span><span class="n">topology</span><span class="p">:</span> <span class="n">Topology</span><span class="p">,</span> <span class="n">atompair</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">ffdir</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a bond in topology.</span>

<span class="sd">    Move an atom (typically H for Hydrogen Atom Transfer) to a new location.</span>
<span class="sd">    Modifies the topology dictionary in place.</span>
<span class="sd">    It keeps track of affected terms in the topology via a graph representation of the topology</span>
<span class="sd">    and applies the necessary changes to bonds, angles and dihedrals (proper and improper).</span>
<span class="sd">    Furthermore, it modifies to function types in the topology to account for radicals.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    topology: dict</span>
<span class="sd">        dictionary representation of the topology</span>
<span class="sd">    movepair: tuple[int, int]</span>
<span class="sd">        a tuple of integers with the atoms indices</span>
<span class="sd">        `from`, the atom being moved and</span>
<span class="sd">        `to`, the atom to which the `from` atom will be bound</span>
<span class="sd">    ffdir: Path</span>
<span class="sd">        path to the forcefield directory. Needs to contain aminoacids.rtp.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">atompair_str</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atompair</span><span class="p">]</span>
    <span class="n">split_dihedrals</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span>

    <span class="c1"># build localGraph and fill it</span>
    <span class="n">to_graph</span> <span class="o">=</span> <span class="n">LocalGraph</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">atompair_str</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ffdir</span><span class="p">,</span> <span class="n">add_bond</span><span class="o">=</span><span class="n">atompair_str</span><span class="p">)</span>

    <span class="c1"># set the correct atomtype,resname for the HAT hydrogen based on the ff definition</span>
    <span class="n">heavy_resname</span> <span class="o">=</span> <span class="n">atompair_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">atmdef</span> <span class="o">=</span> <span class="n">to_graph</span><span class="o">.</span><span class="n">correct_atomprops</span><span class="p">(</span><span class="n">atompair_str</span><span class="p">,</span> <span class="n">heavy_resname</span><span class="p">)</span>
    <span class="n">topol_change_at_an</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">atmdef</span><span class="p">)</span>

    <span class="c1"># this is to prevent overwriting bonds,angles for the newly parameterized &quot;from&quot; part,</span>
    <span class="c1"># if they are next to each other</span>
    <span class="n">atom_terms</span> <span class="o">=</span> <span class="n">to_graph</span><span class="o">.</span><span class="n">parameterize_around_atom</span><span class="p">(</span><span class="n">atompair_str</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">atom_terms</span> <span class="o">=</span> <span class="n">terms_keep_only</span><span class="p">(</span><span class="n">atompair_str</span><span class="p">,</span> <span class="n">heavy_idx</span><span class="p">,</span> <span class="n">atom_terms</span><span class="p">)</span>
    <span class="n">topology</span> <span class="o">=</span> <span class="n">topol_add_terms</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">atom_terms</span><span class="p">)</span>

    <span class="c1"># add pairs of the from_atom at the new position</span>
    <span class="n">atom_terms_from</span> <span class="o">=</span> <span class="n">to_graph</span><span class="o">.</span><span class="n">get_terms_with_atom</span><span class="p">(</span><span class="n">atompair_str</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">add_function</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">,</span> <span class="s2">&quot;propers&quot;</span><span class="p">,</span> <span class="s2">&quot;impropers&quot;</span><span class="p">]:</span>
        <span class="n">atom_terms_from</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">topology</span> <span class="o">=</span> <span class="n">topol_add_terms</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">atom_terms_from</span><span class="p">)</span>

    <span class="c1"># have the right impropers at the to_heavy atom</span>
    <span class="n">atom_terms_add</span><span class="p">,</span> <span class="n">atom_terms_remove</span> <span class="o">=</span> <span class="n">to_graph</span><span class="o">.</span><span class="n">compare_ff_impropers</span><span class="p">(</span>
        <span class="n">heavy_idx</span><span class="p">,</span> <span class="n">atompair_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">topology</span> <span class="o">=</span> <span class="n">topol_add_terms</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">atom_terms_add</span><span class="p">)</span>  <span class="c1"># no need, yet</span>
    <span class="n">topology</span> <span class="o">=</span> <span class="n">topol_remove_terms</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">atom_terms_remove</span><span class="p">)</span>

    <span class="n">topology</span> <span class="o">=</span> <span class="n">merge_propers_impropers</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span></div>


<div class="viewcode-block" id="Atom"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.Atom">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Atom</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Information about one atom</span>

<span class="sd">    A class containing atom information as in the atoms section of the topology.</span>
<span class="sd">    An atom keeps a list of which atoms it is bound to.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">idx</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">atomtype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">atomname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">resname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bound_to</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></div>


<div class="viewcode-block" id="LocalGraph"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph">[docs]</a><span class="k">class</span> <span class="nc">LocalGraph</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">topology</span><span class="p">:</span> <span class="n">Topology</span><span class="p">,</span>
        <span class="n">central_atom_idx</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ffdir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topology</span> <span class="o">=</span> <span class="n">topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">central_atom_idx</span> <span class="o">=</span> <span class="n">central_atom_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ffdir</span> <span class="o">=</span> <span class="n">ffdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">Atom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">central_atom_idx</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proper_dihedrals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improper_dihedrals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">construct_graph</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_lists</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_atoms_list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_bound_to</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_PADs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_lists</span><span class="p">()</span>

<div class="viewcode-block" id="LocalGraph.construct_graph"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.construct_graph">[docs]</a>    <span class="k">def</span> <span class="nf">construct_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        searches the bonds section of a topology up to `depth` bonds deep</span>
<span class="sd">        to create a local graph i.e. filling the self.atoms list and self.bonds list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">curratoms</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">central_atom_idx</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
            <span class="n">addlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">curratoms</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">bond</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">bond</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]:</span>
                            <span class="n">addlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Atom</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">curratoms</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">addlist</span><span class="p">)</span></div>

<div class="viewcode-block" id="LocalGraph.order_lists"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.order_lists">[docs]</a>    <span class="k">def</span> <span class="nf">order_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return early on empty topology</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">check_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">str_to_int_or_0</span><span class="p">)</span>
        <span class="c1"># TODO: find more elegant solution for ordering multiple properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomtype</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomtype</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_bond</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomname</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomname</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_bond</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_resname</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_resname</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_bond</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_bond</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_bond</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_angle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proper_dihedrals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proper_dihedrals</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_dihedral</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improper_dihedrals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">improper_dihedrals</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">sort_improper</span><span class="p">)</span>

        <span class="c1"># keep bonds in proper order (which one goes first in the definition)</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">bond_int</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">if</span> <span class="n">bond_int</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bond_int</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">bond</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span></div>

    <span class="c1"># Propagate changes to all attributes</span>
<div class="viewcode-block" id="LocalGraph.update_atoms_list"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.update_atoms_list">[docs]</a>    <span class="k">def</span> <span class="nf">update_atoms_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_atoms_property</span><span class="p">(</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_atomprop</span><span class="p">(</span><span class="s2">&quot;atomtype&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_atomprop</span><span class="p">(</span><span class="s2">&quot;atomname&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_atomprop</span><span class="p">(</span><span class="s2">&quot;resname&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_atoms_property</span><span class="p">(</span><span class="s2">&quot;atomtype&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_atoms_property</span><span class="p">(</span><span class="s2">&quot;atomname&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms_resname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_atoms_property</span><span class="p">(</span><span class="s2">&quot;resname&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LocalGraph.update_bound_to"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.update_bound_to">[docs]</a>    <span class="k">def</span> <span class="nf">update_bound_to</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bound_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="p">:</span>
            <span class="n">bound_dict</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bound_dict</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                <span class="n">bound_dict</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bound_dict</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                <span class="n">bound_dict</span><span class="p">[</span><span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">atom_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">bound_to</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="n">bound_dict</span><span class="p">[</span><span class="n">atom_idx</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">str_to_int_or_0</span>
            <span class="p">)</span></div>

    <span class="c1"># Retrieve properties</span>
<div class="viewcode-block" id="LocalGraph.get_atomprop"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.get_atomprop">[docs]</a>    <span class="k">def</span> <span class="nf">get_atomprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">property</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">[</span><span class="s2">&quot;atoms&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">property</span> <span class="o">==</span> <span class="s2">&quot;atomtype&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">atomtype</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">property</span> <span class="o">==</span> <span class="s2">&quot;atomname&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">atomname</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">property</span> <span class="o">==</span> <span class="s2">&quot;resname&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span></div>

<div class="viewcode-block" id="LocalGraph.get_atoms_property"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.get_atoms_property">[docs]</a>    <span class="k">def</span> <span class="nf">get_atoms_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">property</span> <span class="o">==</span> <span class="s2">&quot;idx&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">property</span> <span class="o">==</span> <span class="s2">&quot;bound_to&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">bound_to</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">property</span> <span class="o">==</span> <span class="s2">&quot;atomtype&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">atomtype</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">property</span> <span class="o">==</span> <span class="s2">&quot;atomname&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">atomname</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">property</span> <span class="o">==</span> <span class="s2">&quot;resname&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">resname</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t find property </span><span class="si">{}</span><span class="s2"> in object&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">property</span><span class="p">))</span></div>

<div class="viewcode-block" id="LocalGraph.build_PADs"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.build_PADs">[docs]</a>    <span class="k">def</span> <span class="nf">build_PADs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        in:</span>
<span class="sd">        - localGraph with AtomList that contains atom objects with bound_to attribute that contains the bonded atom idxs</span>
<span class="sd">        out:</span>
<span class="sd">        - filled AngleList, ProperList</span>
<span class="sd">        - filled PairList as ProperList outer atoms</span>
<span class="sd">        - ImproperList as defined in the topology</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># define angles</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">bound_to</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">bound_to</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">comb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">comb</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

        <span class="c1"># define propers</span>
        <span class="k">for</span> <span class="n">atom1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">bound_to</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="n">atom1</span><span class="o">.</span><span class="n">bound_to</span><span class="p">:</span>
                    <span class="n">atom2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">partner</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">bound_to</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">):</span>
                        <span class="n">atom1_periphery</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atom1</span><span class="o">.</span><span class="n">bound_to</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                        <span class="n">atom2_periphery</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atom2</span><span class="o">.</span><span class="n">bound_to</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">atom1_periphery</span><span class="p">,</span> <span class="n">atom2_periphery</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">proper_dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">prod</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">prod</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="p">)</span>

        <span class="c1"># take impropers from topology</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">topology</span><span class="p">[</span><span class="s2">&quot;impropers&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">term</span><span class="p">[:</span><span class="mi">4</span><span class="p">]]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">improper_dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>

        <span class="c1"># all pairs have a dihedral between them</span>
        <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proper_dihedrals</span><span class="p">:</span>
            <span class="c1"># check for existing pairs in the case of five membered rings</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">dihedral</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">dihedral</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dihedral</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dihedral</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">dihedral</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dihedral</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span></div>

<div class="viewcode-block" id="LocalGraph.correct_atomprops"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.correct_atomprops">[docs]</a>    <span class="k">def</span> <span class="nf">correct_atomprops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">movepair</span><span class="p">,</span> <span class="n">heavy_resname</span><span class="p">):</span>
        <span class="n">atoms_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span>
        <span class="n">H_atomtype</span><span class="p">,</span> <span class="n">H_atomname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_H_ff_at_an</span><span class="p">(</span><span class="n">movepair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atoms_idxs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">movepair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">atomtype</span> <span class="o">=</span> <span class="n">H_atomtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atoms_idxs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">movepair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">atomname</span> <span class="o">=</span> <span class="n">H_atomname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atoms_idxs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">movepair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">resname</span> <span class="o">=</span> <span class="n">heavy_resname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_atoms_list</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">movepair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">H_atomtype</span><span class="p">,</span>
            <span class="n">H_atomname</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atoms_idxs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">movepair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">resname</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># Methods related to retrieving ff terms from a LocalGraph that contain a certain atom (search for index)</span>
<div class="viewcode-block" id="LocalGraph.search_terms"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.search_terms">[docs]</a>    <span class="k">def</span> <span class="nf">search_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entries</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">entries</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">center</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]:</span>
                <span class="n">hits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hits</span></div>

<div class="viewcode-block" id="LocalGraph.add_function_to_terms"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.add_function_to_terms">[docs]</a>    <span class="k">def</span> <span class="nf">add_function_to_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">termdict</span><span class="p">):</span>
        <span class="n">termdict_funct</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">termdict</span><span class="p">)</span>
        <span class="n">funct_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bonds&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pairs&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;propers&quot;</span><span class="p">:</span> <span class="s2">&quot;9&quot;</span><span class="p">,</span>
            <span class="s2">&quot;impropers&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">,</span> <span class="s2">&quot;pairs&quot;</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">,</span> <span class="s2">&quot;propers&quot;</span><span class="p">,</span> <span class="s2">&quot;impropers&quot;</span><span class="p">]:</span>
            <span class="n">termdict_funct</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">funct_dict</span><span class="p">[</span><span class="n">section</span><span class="p">]]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">termdict_funct</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">termdict_funct</span></div>

<div class="viewcode-block" id="LocalGraph.get_terms_with_atom"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.get_terms_with_atom">[docs]</a>    <span class="k">def</span> <span class="nf">get_terms_with_atom</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">center</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">add_function</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        in:</span>
<span class="sd">        - idx:str           = atom index</span>
<span class="sd">        - center:bool       = take angle/dihedral terms with idx in center positions only</span>
<span class="sd">        - add_function:bool = add GROMACS function # to the terms</span>
<span class="sd">        out:</span>
<span class="sd">        - termdict:dict     = bonds,pairs,angles,propers,impropers containing atom idx</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Atom with index </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> is not in the atoms of the local_graph </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">termdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">termdict</span><span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
        <span class="n">termdict</span><span class="p">[</span><span class="s2">&quot;pairs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
        <span class="n">termdict</span><span class="p">[</span><span class="s2">&quot;angles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
        <span class="n">termdict</span><span class="p">[</span><span class="s2">&quot;propers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proper_dihedrals</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>
        <span class="n">termdict</span><span class="p">[</span><span class="s2">&quot;impropers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_terms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">improper_dihedrals</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_function</span><span class="p">:</span>
            <span class="n">termdict_funct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_function_to_terms</span><span class="p">(</span><span class="n">termdict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">termdict_funct</span>
        <span class="k">return</span> <span class="n">termdict</span></div>

    <span class="c1"># Manipulate attributes</span>
<div class="viewcode-block" id="LocalGraph.add_atom"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.add_atom">[docs]</a>    <span class="k">def</span> <span class="nf">add_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">:</span> <span class="n">Atom</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Atom with idx </span><span class="si">{</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="si">}</span><span class="s2"> already exists!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LocalGraph.add_bond"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.add_bond">[docs]</a>    <span class="k">def</span> <span class="nf">add_bond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bond</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not establish bond between idxs </span><span class="si">{</span><span class="n">bond</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LocalGraph.remove_terms"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.remove_terms">[docs]</a>    <span class="k">def</span> <span class="nf">remove_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">termdict</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing terms </span><span class="si">{</span><span class="n">termdict</span><span class="si">}</span><span class="s2"> from local graph.&quot;</span><span class="p">)</span>
        <span class="n">graphdict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bonds&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
            <span class="s2">&quot;pairs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairs</span><span class="p">,</span>
            <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span>
            <span class="s2">&quot;propers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">proper_dihedrals</span><span class="p">,</span>
            <span class="s2">&quot;impropers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">improper_dihedrals</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pairs&quot;</span><span class="p">,</span> <span class="s2">&quot;bonds&quot;</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">,</span> <span class="s2">&quot;propers&quot;</span><span class="p">,</span> <span class="s2">&quot;impropers&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">termdict</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">graphdict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;removed term </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2"> from graph </span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Couldn&#39;t find term </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2"> in TypeList&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_bound_to</span><span class="p">()</span></div>

    <span class="c1"># Method that interact with the force field files</span>
<div class="viewcode-block" id="LocalGraph.is_radical"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.is_radical">[docs]</a>    <span class="k">def</span> <span class="nf">is_radical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        in:</span>
<span class="sd">        - atom_idx              = index of the atom that is checked for being a radical</span>
<span class="sd">        - self.atoms_atomtype   = atomtypes in the LocalGraph (comes from the topology dict)</span>
<span class="sd">        - nbonds_dict           = # of bonds of amber FF99SB-ILDNP* atomtypes (as written in the paper)</span>
<span class="sd">        out:</span>
<span class="sd">        - bool whether atom_idx is a radical (-&gt; has fewer bonds than would be expected for the atomtype)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># compare to atom type perception paper (2006) same as in HAT_utils.py</span>

        <span class="n">atom_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomtype</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nbonds</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ATOMTYPE_BONDORDER</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">atom_type</span> <span class="ow">in</span> <span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not in atomtype dictionary nbonds_dict&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">atom_type</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Potential radical with index </span><span class="si">{</span><span class="n">atom_idx</span><span class="si">}</span><span class="s2"> is bound to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">bound_to</span><span class="si">}</span><span class="s2"> other atoms&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)]</span><span class="o">.</span><span class="n">bound_to</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nbonds</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atom_idx</span><span class="si">}</span><span class="s2"> is a radical&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atom_idx</span><span class="si">}</span><span class="s2"> is not a radical&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="LocalGraph.ff_AA_todict"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.ff_AA_todict">[docs]</a>    <span class="k">def</span> <span class="nf">ff_AA_todict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ffdir</span> <span class="o">/</span> <span class="s2">&quot;aminoacids.rtp&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
            <span class="n">foo</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">ffaminoacids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;header&quot;</span>
        <span class="n">ffaminoacids</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">subkey</span> <span class="o">=</span> <span class="s2">&quot;header&quot;</span>
        <span class="n">ffaminoacids</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">subkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">foo</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">):</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">ffaminoacids</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">subkey</span> <span class="o">=</span> <span class="s2">&quot;header&quot;</span>
                    <span class="n">ffaminoacids</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">subkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot; [&quot;</span><span class="p">):</span>
                    <span class="n">subkey</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">ffaminoacids</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">subkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;[+-]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>  <span class="c1"># useful?</span>
                    <span class="n">ffaminoacids</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">subkey</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">ffaminoacids</span></div>

<div class="viewcode-block" id="LocalGraph.compare_ff_impropers"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.compare_ff_impropers">[docs]</a>    <span class="k">def</span> <span class="nf">compare_ff_impropers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heavy_idx</span><span class="p">,</span> <span class="n">to_idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;look for obsolete patched improper dihedrals</span>
<span class="sd">        and improper dihedrals in the force field that should be in the topology</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># improper_bbdict = {(&#39;C&#39;,&#39;CA&#39;,&#39;N&#39;,&#39;H&#39;):[&#39;180.00&#39;,&#39;4.60240&#39;,&#39;2&#39;],(&#39;CA&#39;,&#39;N&#39;,&#39;C&#39;,&#39;O&#39;):[&#39;180.00&#39;,&#39;43.93200&#39;,&#39;2&#39;],(&#39;N&#39;,&#39;CA&#39;,&#39;C&#39;,&#39;N&#39;):[&#39;105.4&#39;,&#39;0.75&#39;,&#39;1&#39;]}</span>
        <span class="n">ffaminoacids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff_AA_todict</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">ffaminoacids</span><span class="p">[</span><span class="s2">&quot;ALA&quot;</span><span class="p">][</span><span class="s2">&quot;impropers&quot;</span><span class="p">])</span>

        <span class="n">rmvdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;impropers&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">adddict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;impropers&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">to_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_resname</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">to_idx</span><span class="p">)]</span>
        <span class="n">to_atomname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomname</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">to_idx</span><span class="p">)]</span>

        <span class="n">to_impropers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">improper</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">improper_dihedrals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">to_idx</span> <span class="o">==</span> <span class="n">improper</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">to_impropers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">improper</span><span class="p">)</span>

        <span class="n">impropers_atomnames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span>
                <span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomname</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">improper</span><span class="p">[:</span><span class="mi">4</span><span class="p">]],</span>
                <span class="o">*</span><span class="n">improper</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">improper</span> <span class="ow">in</span> <span class="n">to_impropers</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">improper_atomname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">impropers_atomnames</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">improper_atomname</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ffaminoacids</span><span class="p">[</span><span class="n">to_res</span><span class="p">][</span><span class="s2">&quot;impropers&quot;</span><span class="p">]:</span>
                <span class="n">rmvdict</span><span class="p">[</span><span class="s2">&quot;impropers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">to_impropers</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># TODO: probably need to work on this</span>
        <span class="k">for</span> <span class="n">improper_res</span> <span class="ow">in</span> <span class="n">ffaminoacids</span><span class="p">[</span><span class="n">to_res</span><span class="p">][</span><span class="s2">&quot;impropers&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">to_atomname</span> <span class="o">==</span> <span class="n">improper_res</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">improper_res_idx</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomname</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">improper_res</span>
                <span class="p">]</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Added improper </span><span class="si">{</span><span class="n">improper_res</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">improper_res_idx</span><span class="si">}</span><span class="s2"> from FF&quot;</span>
                <span class="p">)</span>
                <span class="n">adddict</span><span class="p">[</span><span class="s2">&quot;impropers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">*</span><span class="n">improper_res_idx</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">adddict</span><span class="p">,</span> <span class="n">rmvdict</span></div>

    <span class="c1"># TODO: might have to be refined to find the exact atom name</span>
<div class="viewcode-block" id="LocalGraph.get_H_ff_at_an"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.get_H_ff_at_an">[docs]</a>    <span class="k">def</span> <span class="nf">get_H_ff_at_an</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">heavy_idx</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a heavy atom index and searches in</span>
<span class="sd">        the force field aminoacids.rtp for the residue definition of that heavy atom.</span>
<span class="sd">        Then, a bond of that heavy atom to a hydrogen is searched in the residue definition and its</span>
<span class="sd">        atomtype and atomname returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">heavy_atomname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomname</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">heavy_idx</span><span class="p">)]</span>
        <span class="n">heavy_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_resname</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">heavy_idx</span><span class="p">)]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">([</span><span class="n">heavy_atomname</span><span class="p">,</span> <span class="n">heavy_res</span><span class="p">])</span>
        <span class="n">ffaminoacids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff_AA_todict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">ffaminoacids</span><span class="p">[</span><span class="n">heavy_res</span><span class="p">][</span><span class="s2">&quot;bonds&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">heavy_atomname</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">]):</span>
                    <span class="n">H_atomname</span> <span class="o">=</span> <span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">heavy_atomname</span> <span class="k">else</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">ffaminoacids</span><span class="p">[</span><span class="n">heavy_res</span><span class="p">][</span><span class="s2">&quot;atoms&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">H_atomname</span><span class="p">:</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;HAT hydrogen atomtype has been found to be </span><span class="si">{</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> at its new position.&quot;</span>
                            <span class="p">)</span>
                            <span class="k">return</span> <span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">H_atomname</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Found no new atomtype for HAT hydrogen!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LocalGraph.get_ff_sections"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.get_ff_sections">[docs]</a>    <span class="k">def</span> <span class="nf">get_ff_sections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ffbonded</span> <span class="o">=</span> <span class="n">read_topol</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ffdir</span> <span class="o">/</span> <span class="s2">&quot;ffbonded.itp&quot;</span>
        <span class="p">)</span>  <span class="c1"># not intended use of read_topol but should work fine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">[</span><span class="s2">&quot;bondtypes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ffbonded</span><span class="p">[</span><span class="s2">&quot;bondtypes&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">[</span><span class="s2">&quot;angletypes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ffbonded</span><span class="p">[</span><span class="s2">&quot;angletypes&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="LocalGraph.parameterize_bonded_terms"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.parameterize_bonded_terms">[docs]</a>    <span class="k">def</span> <span class="nf">parameterize_bonded_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">terms</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        takes a term (bond or angle) and adds the parameters from</span>
<span class="sd">        the force field ffbonded.itp file that match the atomtypes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Looking for atom parameters in atoms section of topology for </span><span class="si">{</span><span class="n">terms</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">terms</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>
        <span class="n">terms_prm</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">terms_mapped</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomtype</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">term</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">terms_mapped</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ff</span><span class="p">[</span><span class="n">prop</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">term</span> <span class="o">==</span> <span class="n">entry</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">term</span><span class="p">)]</span> <span class="ow">or</span> <span class="n">term</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">entry</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">term</span><span class="p">)]:</span>
                    <span class="n">stop</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
                    <span class="n">terms_prm</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">*</span><span class="n">terms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">*</span><span class="n">entry</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="p">:</span> <span class="n">stop</span><span class="p">]])</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No parameters found for </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">terms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameterized these terms: </span><span class="si">{</span><span class="n">terms_prm</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">terms_prm</span></div>

    <span class="c1"># Parameterization</span>
<div class="viewcode-block" id="LocalGraph.patch_bond"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.patch_bond">[docs]</a>    <span class="k">def</span> <span class="nf">patch_bond</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">bonds</span><span class="p">,</span>
        <span class="n">atom_idx</span><span class="p">,</span>
        <span class="n">newfrac</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span>
        <span class="n">SOfrac</span><span class="o">=</span><span class="mf">0.955</span><span class="p">,</span>
        <span class="n">NCaR_offset</span><span class="o">=</span><span class="mf">0.006</span><span class="p">,</span>
        <span class="n">CNR_offset</span><span class="o">=</span><span class="mf">0.008</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Correct all non-hydrogen bonds of the atom_idx by a factor.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        newfrac:    factor for r_eq of C,N</span>
<span class="sd">        SOfrac:     factor for r_eq of S,O</span>
<span class="sd">        NCaR_offset:offset for r_eq of the N-Ca backbone bond for a radical Ca</span>
<span class="sd">        CNR_offset: offset for r_eq of the C-N backbone for for a radical N</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Patching bonds </span><span class="si">{</span><span class="n">bonds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">:</span>
            <span class="n">partnerpos</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)</span> <span class="o">==</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">radicalpos</span> <span class="o">=</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">partnerpos</span><span class="p">]</span>
            <span class="n">partner_idx</span> <span class="o">=</span> <span class="n">bond</span><span class="p">[</span><span class="n">partnerpos</span><span class="p">]</span>
            <span class="n">partner_atomtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomtype</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">partner_idx</span><span class="p">)]</span>
            <span class="n">radical_atomtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomtype</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)]</span>
            <span class="n">radicalname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomname</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">partner_atomtype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">):</span>
                <span class="c1"># logging.debug(f&quot;{partner_idx} is a hydrogen, no change of parameters necessary!&quot;)</span>
                <span class="k">continue</span>

            <span class="c1"># change to r_eq happens here</span>
            <span class="n">req</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="n">newfrac</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bond</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

            <span class="c1"># special fixes to bond length that are added on top of the general *0.98 factor</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">partner_atomtype</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span>
                <span class="ow">and</span> <span class="n">radical_atomtype</span> <span class="o">==</span> <span class="s2">&quot;CT&quot;</span>
                <span class="ow">and</span> <span class="n">radicalname</span> <span class="o">==</span> <span class="s2">&quot;CA&quot;</span>
            <span class="p">):</span>  <span class="c1"># N-CA of C-alpha atom_idx</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;!!Found CaR!!&quot;</span><span class="p">)</span>
                <span class="n">req</span> <span class="o">-=</span> <span class="n">NCaR_offset</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">partner_atomtype</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span>
                <span class="ow">and</span> <span class="n">radical_atomtype</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span>
                <span class="ow">and</span> <span class="n">radicalname</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span>
            <span class="p">):</span>  <span class="c1"># C-N of N atom_idx</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;!!Found bb NR!!&quot;</span><span class="p">)</span>
                <span class="n">req</span> <span class="o">+=</span> <span class="n">CNR_offset</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">at</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="p">[</span><span class="n">radical_atomtype</span><span class="p">,</span> <span class="n">partner_atomtype</span><span class="p">]):</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">req</span> <span class="o">*</span> <span class="p">(</span><span class="n">SOfrac</span> <span class="o">/</span> <span class="n">newfrac</span><span class="p">)</span>  <span class="c1"># correcting by a different value</span>

            <span class="n">bond</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:7.5f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>  <span class="c1"># will carry back to atom_terms</span>
            <span class="n">bond</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:13.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">bond</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;patched&quot;</span><span class="p">,</span> <span class="s2">&quot;parameter&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="LocalGraph.patch_angle"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.patch_angle">[docs]</a>    <span class="k">def</span> <span class="nf">patch_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angles</span><span class="p">,</span> <span class="n">atom_idx</span><span class="p">,</span> <span class="n">newtheteq</span><span class="o">=</span><span class="mi">117</span><span class="p">,</span> <span class="n">aromatic_offset</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Patching angles </span><span class="si">{</span><span class="n">angles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">:</span>
            <span class="n">radical_atomtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomtype</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)]</span>

            <span class="n">theteq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">angle</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">radical_atomtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CR&quot;</span><span class="p">,</span> <span class="s2">&quot;NA&quot;</span><span class="p">,</span> <span class="s2">&quot;CW&quot;</span><span class="p">,</span> <span class="s2">&quot;CC&quot;</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;CN&quot;</span><span class="p">,</span> <span class="s2">&quot;C*&quot;</span><span class="p">]:</span>
                <span class="n">theteq</span> <span class="o">+=</span> <span class="n">aromatic_offset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theteq</span> <span class="o">=</span> <span class="n">newtheteq</span>

            <span class="n">angle</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:11.7f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">theteq</span><span class="p">)</span>  <span class="c1"># will carry back to atom_terms</span>
            <span class="n">angle</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:10.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">angle</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;patched&quot;</span><span class="p">,</span> <span class="s2">&quot;parameter&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="LocalGraph.patch_dihedral_CA"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.patch_dihedral_CA">[docs]</a>    <span class="k">def</span> <span class="nf">patch_dihedral_CA</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">propers</span><span class="p">,</span>
        <span class="n">atom_idx</span><span class="p">,</span>
        <span class="n">phivals</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;1.6279944&quot;</span><span class="p">,</span> <span class="s2">&quot;21.068532&quot;</span><span class="p">,</span> <span class="s2">&quot;1.447664&quot;</span><span class="p">],</span>
        <span class="n">psivals</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;6.556746&quot;</span><span class="p">,</span> <span class="s2">&quot;20.284450&quot;</span><span class="p">,</span> <span class="s2">&quot;0.297901&quot;</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="c1"># phivals and psivals from own MCSA</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to patch propers </span><span class="si">{</span><span class="n">propers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">radical_resname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_resname</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)]</span>
        <span class="n">radical_atomname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomname</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">radical_resname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Pro&quot;</span><span class="p">,</span> <span class="s2">&quot;Hyp&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">radical_atomname</span> <span class="o">==</span> <span class="s2">&quot;CA&quot;</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Did not add a dihedral term because the atom_idx is in Pro or Hyp (here </span><span class="si">{</span><span class="n">radical_resname</span><span class="si">}</span><span class="s2">) or not a C-alpha (here </span><span class="si">{</span><span class="n">radical_atomname</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">propers</span>

        <span class="n">phi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">propers_mapped</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomname</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dihedral</span><span class="p">[:</span><span class="mi">4</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="n">propers</span>
        <span class="p">]</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dihedrals by atomname </span><span class="si">{</span><span class="n">propers_mapped</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">propers_mapped</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dihedral</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">]:</span>  <span class="c1"># Phi</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">phi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="o">*</span><span class="n">propers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="s2">&quot;180.000000&quot;</span><span class="p">,</span>
                            <span class="n">phivals</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="s2">&quot;;&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;patched&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;parameter&quot;</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="n">dihedral</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;CA&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">]:</span>  <span class="c1"># Psi</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">psi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="o">*</span><span class="n">propers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                            <span class="s2">&quot;180.000000&quot;</span><span class="p">,</span>
                            <span class="n">psivals</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="s2">&quot;;&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;patched&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;parameter&quot;</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="o">*</span><span class="n">phi</span><span class="p">,</span> <span class="o">*</span><span class="n">psi</span><span class="p">]</span></div>

<div class="viewcode-block" id="LocalGraph.patch_improper"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.patch_improper">[docs]</a>    <span class="k">def</span> <span class="nf">patch_improper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_idx</span><span class="p">,</span> <span class="n">newphik</span><span class="o">=</span><span class="s2">&quot;43.93200&quot;</span><span class="p">):</span>
        <span class="c1"># same as backbone N improper or 4.6024000</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to patch improper&quot;</span><span class="p">)</span>

        <span class="n">radical_Atom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Potential improper center </span><span class="si">{</span><span class="n">atom_idx</span><span class="si">}</span><span class="s2"> is bound to </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">radical_Atom</span><span class="o">.</span><span class="n">bound_to</span><span class="p">)</span><span class="si">}</span><span class="s2"> Atoms.&quot;</span>
        <span class="p">)</span>
        <span class="c1"># this would mean atom_idx went from 4 to 3 partners -&gt; tetrahedral to planar</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radical_Atom</span><span class="o">.</span><span class="n">bound_to</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">improper</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">radical_Atom</span><span class="o">.</span><span class="n">bound_to</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">radical_Atom</span><span class="o">.</span><span class="n">bound_to</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">),</span>
                <span class="n">radical_Atom</span><span class="o">.</span><span class="n">bound_to</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s2">&quot;4&quot;</span><span class="p">,</span>
                <span class="s2">&quot;180.0000000&quot;</span><span class="p">,</span>
                <span class="n">newphik</span><span class="p">,</span>
                <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                <span class="s2">&quot;;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;patched&quot;</span><span class="p">,</span>
                <span class="s2">&quot;parameter&quot;</span><span class="p">,</span>
            <span class="p">]</span>  <span class="c1"># improper entry</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">improper</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="LocalGraph.parameterize_around_atom"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.LocalGraph.parameterize_around_atom">[docs]</a>    <span class="k">def</span> <span class="nf">parameterize_around_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_idx</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; --- Parameterizing around atom </span><span class="si">{</span><span class="n">atom_idx</span><span class="si">}</span><span class="s2"> ---</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_idx</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomtype</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_atomname</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms_resname</span><span class="p">)</span>

        <span class="n">atom_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_terms_with_atom</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;pairs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># deal with ff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_ff_sections</span><span class="p">()</span>
        <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterize_bonded_terms</span><span class="p">(</span>
            <span class="s2">&quot;bondtypes&quot;</span><span class="p">,</span> <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;angles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameterize_bonded_terms</span><span class="p">(</span>
            <span class="s2">&quot;angletypes&quot;</span><span class="p">,</span> <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;angles&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># adding function to propers, impropers</span>
        <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;propers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;9&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;propers&quot;</span><span class="p">]]</span>
        <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;impropers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;impropers&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># apply patches</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_radical</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patch_bond</span><span class="p">(</span><span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;bonds&quot;</span><span class="p">],</span> <span class="n">atom_idx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">patch_angle</span><span class="p">(</span><span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;angles&quot;</span><span class="p">],</span> <span class="n">atom_idx</span><span class="p">)</span>
            <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;propers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_dihedral_CA</span><span class="p">(</span>
                <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;propers&quot;</span><span class="p">],</span> <span class="n">atom_idx</span>
            <span class="p">)</span>
            <span class="n">atom_terms</span><span class="p">[</span><span class="s2">&quot;impropers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">patch_improper</span><span class="p">(</span><span class="n">atom_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">atom_terms</span></div></div>


<div class="viewcode-block" id="find_heavy"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.find_heavy">[docs]</a><span class="k">def</span> <span class="nf">find_heavy</span><span class="p">(</span><span class="n">bonds</span><span class="p">,</span> <span class="n">H_idx</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    takes the bonds section of a topology object and an atom index</span>
<span class="sd">    to return the index of the first found bond partner.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">bonds</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">H_idx</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">H_idx</span> <span class="o">==</span> <span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">H_idx</span> <span class="o">==</span> <span class="n">bond</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">bond</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s1">&#39;Atom from ConversionRecipe not found in &quot;bonds&quot; section of the topology&#39;</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="terms_keep_only"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.terms_keep_only">[docs]</a><span class="k">def</span> <span class="nf">terms_keep_only</span><span class="p">(</span><span class="n">movepair</span><span class="p">,</span> <span class="n">heavy_idx</span><span class="p">,</span> <span class="n">atom_terms</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    this is to stop overwriting bonds,angles for the newly parameterized &quot;from&quot; part if they are next to each other</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mapsection</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bonds&quot;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;propers&quot;</span><span class="p">:</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)}</span>
    <span class="n">rmvdict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bonds&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;propers&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">rmvdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">atom_terms</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">movepair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">term</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">heavy_idx</span> <span class="ow">in</span> <span class="n">term</span><span class="p">[</span><span class="n">mapsection</span><span class="p">[</span><span class="n">section</span><span class="p">]]:</span>
                <span class="n">rmvdict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">rmvdict</span><span class="p">[</span><span class="n">section</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">atom_terms</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">atom_terms</span></div>


<span class="c1">## operations on the topology dict</span>
<div class="viewcode-block" id="topol_add_terms"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.topol_add_terms">[docs]</a><span class="k">def</span> <span class="nf">topol_add_terms</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">adddict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    adds terms from adddict to the topologydict and returns the modified dictionary</span>
<span class="sd">    this could mean replacing or adding terms</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding/replacing following terms: </span><span class="si">{</span><span class="n">adddict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">copydict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span>
    <span class="n">mapsection</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pairs&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;bonds&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;propers&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;impropers&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
    <span class="n">sortkeys</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pairs&quot;</span><span class="p">:</span> <span class="n">sort_bond</span><span class="p">,</span>
        <span class="s2">&quot;bonds&quot;</span><span class="p">:</span> <span class="n">sort_bond</span><span class="p">,</span>
        <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="n">sort_angle</span><span class="p">,</span>
        <span class="s2">&quot;propers&quot;</span><span class="p">:</span> <span class="n">sort_dihedral</span><span class="p">,</span>
        <span class="s2">&quot;impropers&quot;</span><span class="p">:</span> <span class="n">sort_improper</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pairs&quot;</span><span class="p">,</span> <span class="s2">&quot;bonds&quot;</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">,</span> <span class="s2">&quot;propers&quot;</span><span class="p">,</span> <span class="s2">&quot;impropers&quot;</span><span class="p">]:</span>
        <span class="n">mapval</span> <span class="o">=</span> <span class="n">mapsection</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">adddict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">adddict</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">searchlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">mapval</span><span class="p">))),</span> <span class="n">copydict</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>
                    <span class="p">)</span>  <span class="c1"># creating list of</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">section</span> <span class="o">==</span> <span class="s2">&quot;propers&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">term</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">]</span>
                    <span class="p">):</span>  <span class="c1"># unhappy that I have to add this line to get all three dihedral terms</span>
                        <span class="n">copydict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;appended term </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2"> to section </span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2"> because it is thought to be part of a multi-dihedral term&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">copydict</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">searchlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">term</span><span class="p">[:</span><span class="n">mapval</span><span class="p">]))]</span> <span class="o">=</span> <span class="n">term</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;replaced previous term with </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;term </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2"> not in topology section </span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">, appending it at the end&quot;</span>
                    <span class="p">)</span>
                    <span class="n">copydict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            <span class="n">copydict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">copydict</span><span class="p">[</span><span class="n">section</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">sortkeys</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sorted section: </span><span class="si">{</span><span class="n">copydict</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">rmv_dih</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">prevdih</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">copydict</span><span class="p">[</span><span class="s2">&quot;propers&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">entry</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">prevdih</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prevdih</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">rmv_dih</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prevdih</span> <span class="o">=</span> <span class="n">entry</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing propers at these positions: </span><span class="si">{</span><span class="n">rmv_dih</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">rmv_dih</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">del</span> <span class="n">copydict</span><span class="p">[</span><span class="s2">&quot;propers&quot;</span><span class="p">][</span><span class="n">val</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">copydict</span></div>


<div class="viewcode-block" id="topol_remove_terms"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.topol_remove_terms">[docs]</a><span class="k">def</span> <span class="nf">topol_remove_terms</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">rmvdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    removes terms in rmvdict that are part of the topologydict and returns the modified dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting following terms: </span><span class="si">{</span><span class="n">rmvdict</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">copydict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">topology</span><span class="p">)</span>
    <span class="n">mapsection</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pairs&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;bonds&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;propers&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;impropers&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pairs&quot;</span><span class="p">,</span> <span class="s2">&quot;bonds&quot;</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">,</span> <span class="s2">&quot;propers&quot;</span><span class="p">,</span> <span class="s2">&quot;impropers&quot;</span><span class="p">]:</span>
        <span class="n">mapval</span> <span class="o">=</span> <span class="n">mapsection</span><span class="p">[</span><span class="n">section</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">rmvdict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">rmvdict</span><span class="p">[</span><span class="n">section</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">searchlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">mapval</span><span class="p">))),</span> <span class="n">copydict</span><span class="p">[</span><span class="n">section</span><span class="p">])</span>
                    <span class="p">)</span>  <span class="c1"># creating list of</span>
                    <span class="k">del</span> <span class="n">copydict</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">searchlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">term</span><span class="p">[:</span><span class="n">mapval</span><span class="p">]))]</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;removed term </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Couldn&#39;t remove term </span><span class="si">{</span><span class="n">term</span><span class="si">}</span><span class="s2"> because it is not part of the topology section </span><span class="si">{</span><span class="n">section</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

    <span class="k">return</span> <span class="n">copydict</span></div>


<div class="viewcode-block" id="topol_change_at_an"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.topol_change_at_an">[docs]</a><span class="k">def</span> <span class="nf">topol_change_at_an</span><span class="p">(</span><span class="n">topology</span><span class="p">,</span> <span class="n">atom</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    changing the atoms entry of topology to give the HAT hydrogen the right atomtype and atomname</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">topology</span><span class="p">[</span><span class="s2">&quot;atoms&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">entry</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">entry</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">str_to_int_or_0</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">topology</span><span class="p">[</span><span class="s2">&quot;atoms&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;changed at/an of </span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">atom</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">entry</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="modify_plumed"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.modify_plumed">[docs]</a><span class="k">def</span> <span class="nf">modify_plumed</span><span class="p">(</span>
    <span class="n">recipe</span><span class="p">:</span> <span class="n">ConversionRecipe</span><span class="p">,</span>
    <span class="n">oldplumeddat</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">newplumeddat</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">plumeddist</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Reading: </span><span class="si">{</span><span class="n">oldplumeddat</span><span class="si">}</span><span class="s2"> and writing modified plumed input to </span><span class="si">{</span><span class="n">newplumeddat</span><span class="si">}</span><span class="s2">.&quot;</span>
    <span class="p">)</span>
    <span class="n">plumeddat</span> <span class="o">=</span> <span class="n">read_plumed</span><span class="p">(</span><span class="n">oldplumeddat</span><span class="p">)</span>

    <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">recipe</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">recipe</span><span class="o">.</span><span class="n">atom_idx</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">ConversionType</span><span class="o">.</span><span class="n">BREAK</span><span class="p">:</span>
            <span class="n">plumeddat</span> <span class="o">=</span> <span class="n">break_bond_plumed</span><span class="p">(</span><span class="n">plumeddat</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">plumeddist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">ConversionType</span><span class="o">.</span><span class="n">MOVE</span><span class="p">:</span>
            <span class="n">plumeddat</span> <span class="o">=</span> <span class="n">move_bond_plumed</span><span class="p">(</span><span class="n">plumeddat</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">plumeddist</span><span class="p">)</span>

    <span class="n">write_plumed</span><span class="p">(</span><span class="n">plumeddat</span><span class="p">,</span> <span class="n">newplumeddat</span><span class="p">)</span></div>


<div class="viewcode-block" id="break_bond_plumed"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.break_bond_plumed">[docs]</a><span class="k">def</span> <span class="nf">break_bond_plumed</span><span class="p">(</span><span class="n">plumeddat</span><span class="p">,</span> <span class="n">breakpair</span><span class="p">,</span> <span class="n">plumeddist</span><span class="p">):</span>
    <span class="n">new_distances</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">broken_distances</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">breakpair</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">breakpair</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">plumeddat</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;atoms&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">breakpair</span><span class="p">):</span>
            <span class="n">broken_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">plumeddat</span><span class="p">[</span><span class="s2">&quot;distances&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_distances</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">plumeddat</span><span class="p">[</span><span class="s2">&quot;prints&quot;</span><span class="p">]:</span>
        <span class="n">line</span><span class="p">[</span><span class="s2">&quot;ARG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[</span><span class="s2">&quot;ARG&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">broken_distances</span><span class="p">]</span>
        <span class="n">line</span><span class="p">[</span><span class="s2">&quot;FILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plumeddist</span>

    <span class="k">return</span> <span class="n">plumeddat</span></div>


<div class="viewcode-block" id="move_bond_plumed"><a class="viewcode-back" href="../../kimmdy.html#kimmdy.changemanager.move_bond_plumed">[docs]</a><span class="k">def</span> <span class="nf">move_bond_plumed</span><span class="p">(</span><span class="n">plumeddat</span><span class="p">,</span> <span class="n">movepair</span><span class="p">,</span> <span class="n">plumeddist</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s2">&quot;Plumeddat Changer for moving Atoms is not implemented yet.&quot;</span>
    <span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Jannik Buhr, Eric Hartmann, Benedikt Rennekamp, Kai Riedmiller.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>